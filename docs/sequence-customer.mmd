sequenceDiagram
    title Customer Sequence Diagram - Restaurant Reservation System

    actor Customer
    participant UI as JavaFX UI
    participant AuthSvc as AuthenticationService
    participant ResSvc as ReservationService
    participant TableSvc as TableAvailabilityService
    participant CustSvc as CustomerService
    participant UserRepo as UserRepository
    participant ResRepo as ReservationRepository
    participant TableRepo as TableRepository
    participant CustRepo as CustomerRepository
    participant SessionRepo as UserSessionRepository

    %% ============================================
    %% FLOW 1: Customer Login
    %% ============================================
    rect rgb(230, 245, 255)
        Note over Customer,SessionRepo: Authentication Flow
        Customer->>UI: Enter username & password
        UI->>AuthSvc: login(LoginRequest)
        AuthSvc->>UserRepo: findByUsername(username)
        UserRepo-->>AuthSvc: Optional<User>
        
        alt User not found or inactive
            AuthSvc-->>UI: AuthenticationException
            UI-->>Customer: Display error message
        else User found and active
            AuthSvc->>AuthSvc: verifyPassword(password, hash)
            alt Password invalid
                AuthSvc-->>UI: AuthenticationException
                UI-->>Customer: Display "Invalid credentials"
            else Password valid
                AuthSvc->>AuthSvc: generateSessionToken()
                AuthSvc->>SessionRepo: save(UserSession)
                SessionRepo-->>AuthSvc: UserSession (with ID)
                AuthSvc->>UserRepo: update(user.lastLogin)
                AuthSvc-->>UI: LoginResponse(token, user, permissions)
                UI-->>Customer: Navigate to Dashboard
            end
        end
    end

    %% ============================================
    %% FLOW 2: Browse Table Availability
    %% ============================================
    rect rgb(255, 245, 230)
        Note over Customer,TableRepo: Browse Availability Flow
        Customer->>UI: Select date, time, party size
        UI->>TableSvc: getAvailableTables(restaurantId, dateTime, partySize)
        TableSvc->>TableRepo: findActiveTablesBySectionId(sectionId)
        TableRepo-->>TableSvc: List<Table>
        TableSvc->>ResRepo: hasConflictingReservation(tableId, dateTime, duration)
        ResRepo-->>TableSvc: boolean (conflict status)
        TableSvc-->>UI: List<Table> (available only)
        UI-->>Customer: Display available tables with capacity
    end

    %% ============================================
    %% FLOW 3: Create Reservation
    %% ============================================
    rect rgb(230, 255, 230)
        Note over Customer,ResRepo: Create Reservation Flow
        Customer->>UI: Fill reservation form (date, time, party size, requests)
        Customer->>UI: Select preferred table (or auto-assign)
        UI->>ResSvc: createReservation(CreateReservationRequest)
        
        ResSvc->>CustRepo: findById(customerId)
        CustRepo-->>ResSvc: Customer
        
        alt Table specified
            ResSvc->>TableRepo: findById(tableId)
            TableRepo-->>ResSvc: Table
            ResSvc->>ResSvc: validateCapacity(table, partySize)
            ResSvc->>ResRepo: hasConflictingReservation(tableId, dateTime)
            ResRepo-->>ResSvc: boolean
        else Auto-assign table
            ResSvc->>TableSvc: getOptimalTable(restaurantId, dateTime, partySize)
            TableSvc->>TableRepo: findActiveTablesBySectionId()
            TableRepo-->>TableSvc: List<Table>
            TableSvc-->>ResSvc: Optional<Table> (smallest suitable)
        end
        
        alt Conflict or no availability
            ResSvc-->>UI: ReservationException
            UI-->>Customer: Display error with alternatives
        else Available
            ResSvc->>ResRepo: save(Reservation)
            ResRepo-->>ResSvc: Reservation (with ID, status=CONFIRMED)
            ResSvc-->>UI: Reservation
            UI-->>Customer: Display confirmation with details
        end
    end

    %% ============================================
    %% FLOW 4: View Own Reservations
    %% ============================================
    rect rgb(245, 230, 255)
        Note over Customer,ResRepo: View Reservations Flow
        Customer->>UI: Navigate to "My Reservations"
        UI->>ResSvc: getReservationsByCustomer(customerId)
        ResSvc->>ResRepo: findByCustomerId(customerId)
        ResRepo-->>ResSvc: List<Reservation>
        ResSvc->>ResSvc: toResponses(reservations)
        ResSvc->>CustRepo: findById() [enrich customer name]
        ResSvc->>TableRepo: findById() [enrich table number]
        ResSvc-->>UI: List<ReservationResponse>
        UI-->>Customer: Display reservations list with details
    end

    %% ============================================
    %% FLOW 5: Cancel Reservation
    %% ============================================
    rect rgb(255, 230, 230)
        Note over Customer,ResRepo: Cancel Reservation Flow
        Customer->>UI: Select reservation to cancel
        UI->>ResSvc: cancelReservation(reservationId)
        ResSvc->>ResRepo: findById(reservationId)
        ResRepo-->>ResSvc: Reservation
        ResSvc->>ResSvc: setStatus(CANCELLED)
        ResSvc->>ResRepo: update(reservation)
        ResRepo-->>ResSvc: Reservation (updated)
        ResSvc-->>UI: Reservation
        UI-->>Customer: Display cancellation confirmation
    end

    %% ============================================
    %% FLOW 6: Update Own Profile
    %% ============================================
    rect rgb(255, 255, 230)
        Note over Customer,CustRepo: Update Profile Flow
        Customer->>UI: Edit profile information
        UI->>CustSvc: updateCustomer(customerId, UpdateCustomerRequest)
        CustSvc->>CustRepo: findById(customerId)
        CustRepo-->>CustSvc: Customer
        
        alt Email changed
            CustSvc->>CustSvc: validateEmail(newEmail)
            CustSvc->>CustRepo: findByEmail(newEmail)
            CustRepo-->>CustSvc: Optional<Customer>
            alt Email already exists
                CustSvc-->>UI: CustomerException("Email exists")
                UI-->>Customer: Display error
            end
        end
        
        CustSvc->>CustSvc: Apply updates (name, phone, allergies, notes)
        CustSvc->>CustRepo: update(customer)
        CustRepo-->>CustSvc: Customer (updated)
        CustSvc-->>UI: Customer
        UI-->>Customer: Display success message
    end

    %% ============================================
    %% FLOW 7: Logout
    %% ============================================
    rect rgb(240, 240, 240)
        Note over Customer,SessionRepo: Logout Flow
        Customer->>UI: Click Logout
        UI->>AuthSvc: logout(sessionToken)
        AuthSvc->>SessionRepo: expireSession(token)
        SessionRepo-->>AuthSvc: boolean (success)
        AuthSvc-->>UI: void
        UI-->>Customer: Navigate to Login screen
    end

